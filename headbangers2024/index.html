<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PM7ZMMTJG2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-PM7ZMMTJG2');
    </script>
    <title>Headbanger's boat 2024</title>
    <link rel="stylesheet" href="style.css?v1">
    
    <script type="module">
        
        import * as common from './common.js?v2';
        
        let day = 1;
        let yVenueHeight = 150;
        let yTopHeight = yVenueHeight;
        let yVenueBottom = yVenueHeight;
        let yEarliestBufferHours = 1;
        let yLatestBufferHours = 2;
        let fontVenue = 40 + 'px serif';
        let fontLeftTime = 35 + 'px serif';
        let fontCurrentTime = 40 + 'px serif';
        let fontGoingButton = 30 + 'px serif';
        let fontCloseButton = 35 + 'px serif';
        let fontSchedule = 35 + 'px serif';

        let xTimeOnLeftWidth = 100;

        let yTimeHourHeight = 400;
        let yTimePushLeftDown = 100;
        let secondsInAnHour = 60 * 60;
        let milliSecondsInAnHour = secondsInAnHour * 1000;

        let fullWidth = window.innerWidth;
        let xBlockWidth = (fullWidth - xTimeOnLeftWidth) / common.locations.length;
       
        let yHiddenButtonHeight = 1000;

        let colorVenueBack = 'darkgrey';
        let colorVenueFont = 'black';
        let colorCurrentTimeNumberBackground = 'black';
        let colorCurrentTimeNumber = 'white';
        let colorCurrentTimeLine = 'fuchsia';
        let colorLeftTimeLines = 'darkgrey';
        let colorLeftTimesNumber = 'cyan';
        let colorLeftTimesBackground = "hsla(0, 0%, 0%, 1)";
        let colorHiddenBackground = 'lightblue';
        let colorHiddenFont = 'black';
        let colorGoingButtonActiveBackground = "hsla(0, 0%, 90%, 1)";
        let colorGoingButtonNonActiveBackground = "hsla(0, 0%, 50%, 1)";
        let colorDayBackgroundInactive = 'grey';
        let colorDayBackgroundActive = 'gold';
        let colorGoToBackground = "lightblue";

        let colorEventBack = '#696969';
        let colorEventFont = 'lightgrey';

        //goTo and close text are used in processing
        let goToButtonText = "GoTo";
        let closeButtonText = "Close";
        
        // these need to be reset every redraw so don't initialize them here
        let eventNameToEvents;
        let dayToData;
        let bandToBandInfo;

        let pauseRefreshing = false;

        function primeBandToBandInfo()
        {
            bandToBandInfo = new Map();
            let bands = common.bandInfo;
            for (let i = 0; i < bands.length; i++) {
                let band = bands[i];
                bandToBandInfo.set(band[0], {genre: band[1]});
            }
            
        }

        function primeData() {
            eventNameToEvents = new Map();
            dayToData = new Map();
            primeBandToBandInfo();
            for (var dayIndex = 0; dayIndex < common.schedule.length; dayIndex++) {
                let currentEvents = common.schedule[dayIndex];
                let eventsSplit = currentEvents.split("\n");
                let events = [];
                let earliestStart = common.getDateTime("2100", "Jan", "1", "1:00", "AM");
                let latestEnd = common.getDateTime("2000", "Jan", "1", "1:00", "AM");
                let earliestEvent;
                let latestEvent;
                for (let i = 0; i < eventsSplit.length; i++) {

                    if (!eventsSplit[i] || eventsSplit[i].trim() == "") {
                        continue;
                    }
                    let eventWithDay = eventsSplit[i] + "," + (dayIndex + 1);
                    let event = common.getEventFromCommas(eventWithDay);

                    events.push(event);

                    let startTime = getStartDateTime(event);
                    if (startTime < earliestStart) {
                        earliestStart = startTime;
                        earliestEvent = event;
                    }

                    let endTime = getEndDateTime(event);
                    if (endTime > latestEnd) {
                        latestEnd = endTime;
                        latestEvent = event;
                    }
                    addToEventNameToEventsMap(event);

                }

                events.forEach(event => {
                    let eventStartDate = getStartDateTime(event);
                    let eventEndDate = getEndDateTime(event);
                    events.forEach(eventCompare => {
                        if (event.name != eventCompare.name)
                        {
                            let eventStartDateCompare = getStartDateTime(eventCompare);
                            let eventEndDateCompare = getEndDateTime(eventCompare);

                            if (eventStartDate < eventEndDateCompare && eventStartDateCompare < eventEndDate)
                            {
                                let goingInd = localStorage.getItem(common.getGoingKey(eventCompare));
                                if (goingInd == null) {
                                    goingInd = common.goingUndecided;
                                }
                                event.overlap += eventCompare.name + "(" + goingInd + ") ";
                            }
                        }
                    });
                });


                //remove minutes and add some buffer time
                let hourAndMinuteEarliest = earliestEvent.startTime.split(":");
                earliestStart = common.getDateTime(common.year, earliestEvent.startMonth, earliestEvent.startDay, (hourAndMinuteEarliest[0]) + ":00", earliestEvent.startAMPM)
                earliestStart = new Date(earliestStart.getTime() - (milliSecondsInAnHour * yEarliestBufferHours));
                let hourAndMinuteLatest = latestEvent.endTime.split(":");
                latestEnd = common.getDateTime(common.year, latestEvent.endMonth, latestEvent.endDay, (hourAndMinuteLatest[0]) + ":00", latestEvent.endAMPM)
                latestEnd = new Date(latestEnd.getTime() + (milliSecondsInAnHour * yLatestBufferHours));

                let data = {
                    earliestStart: earliestStart,
                    latestEnd: latestEnd,
                    events: events
                };
                dayToData.set((dayIndex + 1), data);
            }
        }

        function addToEventNameToEventsMap(event) {
            let events =eventNameToEvents.get(event.name);
            if (events == null) {
                events = [];
               eventNameToEvents.set(event.name, events);
            }
            events.push(event);
        }

        function redrawEverything() {
            console.log("refreshing");
            if (pauseRefreshing)
            {
                console.log("refreshing is paused");
                return;
            }

            deleteEverything();

            primeData();

            let storedDay = localStorage.getItem(common.storedDayKey);

            if (storedDay == undefined || storedDay == "undefined" || isNaN(storedDay)) {
                day = Number(1);
            }
            else {
                day = Number(storedDay);
                if (day < 1 || day > 4) {
                    //somehow it was 0 once
                    day = 1;
                    localStorage.setItem(common.storedDayKey, 1);
                }
            }

            drawTimeline();
            buttons();
            drawTop();
            
            let scrollTo = localStorage.getItem(common.storedScrollToKey);
            if (scrollTo != "-1") {
                window.scroll(0, Number(scrollTo));
            }
            localStorage.setItem(common.storedScrollToKey, -1);
        }

        function deleteAll(element, tagName)
        {
            let elements = element.getElementsByTagName(tagName);
            while (elements.length > 0) {
                for (var i = 0; i < elements.length; i++) {
                    elements[i].remove();
                }
                elements = element.getElementsByTagName(tagName);
            }
        }

        function deleteEverything()
        {
            let schedule = document.getElementById("schedule");

            deleteAll(schedule, 'button');
            deleteAll(schedule, 'label');
            deleteAll(schedule, 'div');
            
            let top = document.getElementById('top');
            deleteAll(top, 'button');
            
        }

        
        function drawTop() {
            let top = document.getElementById('top');
            top.style.width = fullWidth;
            top.style.height = yTopHeight;
            
            let buttonTopLeft = document.createElement('button');
            buttonTopLeft.style.position = 'absolute';
            buttonTopLeft.style.left = 0 + 'px';

            buttonTopLeft.style.top = 0 + 'px';
            buttonTopLeft.style.width = xTimeOnLeftWidth;
            buttonTopLeft.style.height = yVenueHeight;
            //buttonTopLeft.style.backgroundImage = "url(images/hands.png)";
            buttonTopLeft.innerText = "TAP FOR INFO";
            buttonTopLeft.style.font = '35px serif';
            
            buttonTopLeft.style.color = "hsla(0, 0%, 80%, 1)";
            buttonTopLeft.style.backgroundColor = "hsla(0, 0%, 10%, 1)";
            buttonTopLeft.style.backgroundSize = 'cover';
            buttonTopLeft.style.backgroundPosition = 'center';
            buttonTopLeft.addEventListener("click", buttonTopLeftClick);

            top.appendChild(buttonTopLeft);

            for (var i = 0; i < common.locations.length; i++) {

                let buttonVenue = document.createElement('button');
                buttonVenue.style.position = 'absolute';
                buttonVenue.style.left = xTimeOnLeftWidth + (xBlockWidth * i) + 'px';

                buttonVenue.style.top = 0 + 'px';
                buttonVenue.style.width = xBlockWidth;
                buttonVenue.style.height = yVenueHeight;
                let venueText = common.locations[i].abbrev + ":" + getDelayMinutesForVenue(common.locations[i].abbrev) + "m " + common.locations[i].location;
                
                let buttonText = document.createElement("label");
                buttonText.innerText =venueText;
                buttonText.style.color = "red";
                buttonText.style.backgroundColor = "rgba(0, 0, 0, 0.8)"; // Set the background color of the text
                buttonVenue.appendChild(buttonText);

                buttonVenue.style.font = fontVenue;
                buttonVenue.style.backgroundColor = colorVenueBack;
                buttonVenue.style.color = colorVenueFont;
                buttonVenue.style.borderRadius = "12px";
                buttonVenue.style.zIndex = 10000000;
                buttonVenue.style.backgroundSize = 'cover';
                buttonVenue.style.backgroundPosition = 'center';
                //buttonVenue.innerText = venueText;
                buttonVenue.style.backgroundImage = "url(images/hands.png)";
                buttonVenue.addEventListener("click", venueClick);

                top.appendChild(buttonVenue);

            }
        }
        
        function buttonTopLeftClick() {
        	alert("-The venues, schedule, and bottom buttons all do things when tapped, so, tap stuff and see what it does.\n" +
              "-The current time will be drawn on the schedule, so tapping \"now\" will go to that when the shows start.\n" +
              "-Need data for this to work onboard.  All the going statuses may suddenly reset.  I may break it at any point.  No guarantees on this site's reliability, basically.\n");
        }

        function venueClick(venueClicked) {

            let venueAbbrev = venueClicked.target.textContent.split(":")[0];
            let venue;
            for (var i = 0; i < common.locations.length; i++) {
                if (common.locations[i].abbrev == venueAbbrev)
                {
                    venue = common.locations[i];
                    break;
                }
            }

            let note = "";
            if (venue.note != "" && venue.note != undefined)
            {
                note += ". " + venue.note;
            }

            let delayStr = prompt("Minutes delayed for " + venue.fullName + " day " + day + note, getDelayMinutesForVenue(venue));
            if (delayStr == null || "" == delayStr) {
                return;
            }
            let delay = parseInt(delayStr);
            if (Number.isNaN(delay)) {
                alert(delayStr + " is not a number");
                return;
            }
            localStorage.setItem(getDelayKey(venue.abbrev), delay);
            redrawEverything();
        }

        function getDelayKey(venue) {
            return common.storedDelayKey + day + venue;
        }

        function getDelayMinutesForVenue(venue) {
            let delayMinutes = localStorage.getItem(getDelayKey(venue));
            if (delayMinutes == null) {
                return 0;
            }
            return delayMinutes;
        }

        function drawTimeline() {
            let data = dayToData.get(day);
            let schedule = document.getElementById("schedule");

            let height = getYPixelLocation(data.earliestStart, data.latestEnd);
            schedule.style.height = getYPixelLocation(data.earliestStart, data.latestEnd) + "px";

            drawTimeOnLeft(data.earliestStart, data.latestEnd);
            drawCurrentTime(data.earliestStart);
            drawEventsSchedule(data.events, data.earliestStart);

        }

        function drawCurrentTime(earliestStart) {

            let schedule = document.getElementById("schedule");
            let currentTime = new Date();    
            
            if (currentTime > common.storedTimeTEST)
            {
                common.storedTimeTEST = currentTime;
            }
            let pixel = getYPixelLocation(earliestStart, common.storedTimeTEST);

            let labelCurrentTimeNumber = document.createElement('label');
            labelCurrentTimeNumber.style.position = 'absolute';
            labelCurrentTimeNumber.style.left = 0 + 'px';

            labelCurrentTimeNumber.style.top = (pixel + yTimePushLeftDown) + 'px';
            labelCurrentTimeNumber.style.width = xBlockWidth;
            labelCurrentTimeNumber.style.height = yTimeHourHeight;
            let minutes = common.storedTimeTEST.getMinutes();
            let minutesString;
            if (minutes < 10) {
                minutesString = "0" + minutes;
            }
            else {
                minutesString = minutes;
            }
            let hours = common.storedTimeTEST.getHours();
            let hoursString;
            if (hours > 12) {
                hoursString = hours - 12;
            }
                else if (hours == 0) {
                hoursString = 12;
            }
            else {
                hoursString = hours;
            }

            labelCurrentTimeNumber.textContent = hoursString + ":" + minutesString;
            labelCurrentTimeNumber.style.font = fontCurrentTime;
            labelCurrentTimeNumber.style.background = colorCurrentTimeNumberBackground;
            labelCurrentTimeNumber.style.color = colorCurrentTimeNumber;
            labelCurrentTimeNumber.style.height = 50;
            labelCurrentTimeNumber.style.width = xTimeOnLeftWidth;

            schedule.appendChild(labelCurrentTimeNumber);

            let labelCurentTimeLine = document.createElement('label');
            labelCurentTimeLine.style.position = 'absolute';
            labelCurentTimeLine.style.left = 0 + 'px';

            labelCurentTimeLine.style.top = (pixel + yTimePushLeftDown) + 'px';
            labelCurentTimeLine.style.width = fullWidth;
            labelCurentTimeLine.style.height = 5;
            labelCurentTimeLine.style.background = colorCurrentTimeLine;

            schedule.appendChild(labelCurentTimeLine);
        }

        function getStartDateTime(event) {
            return common.getDateTime(common.year, event.startMonth, event.startDay, event.startTime, event.startAMPM);
        }
        function getEndDateTime(event) {
            return common.getDateTime(common.year, event.endMonth, event.endDay, event.endTime, event.endAMPM);
        }

        function drawTimeOnLeft(earliestStart, latestEnd) {
            let schedule = document.getElementById("schedule");
            
            let startMinutes = earliestStart.getMinutes();

            let drawingTime = earliestStart;
            while (drawingTime < latestEnd) {
                let yPixelLocation = getYPixelLocation(earliestStart, drawingTime);

                let labelLeftTimes = document.createElement('label');
                labelLeftTimes.style.position = 'absolute';
                labelLeftTimes.style.left = 0 + 'px';

                labelLeftTimes.style.top = (yPixelLocation + yTimePushLeftDown) + 'px';
                labelLeftTimes.style.width = xTimeOnLeftWidth;
                labelLeftTimes.style.height = yTimeHourHeight;
                let startMinutesString;
                if (startMinutes < 10) {
                    startMinutesString = "0" + startMinutes;
                }
                else {
                    startMinutesString = startMinutes;
                }

                let hourString;
                let ampm = "AM";
                let drawingHour = drawingTime.getHours();
                //TODO clean this up
                if (drawingHour > 12) {
                    hourString = drawingHour - 12;
                    if (drawingHour == 24) {
                        ampm = "AM";
                        hourString = 12;
                    }
                    else {
                        ampm = "PM";
                    }
                }
                else {
                    if (drawingHour == 12) {
                        ampm = "PM";
                        hourString = drawingHour;
                    }
                    else {
                        ampm = "AM";
                        hourString = drawingHour;
                    }
                    if (drawingHour == 0) {
                        hourString = 12;
                    }
                }

                labelLeftTimes.textContent = hourString + ampm;
                labelLeftTimes.style.font = fontLeftTime;
                labelLeftTimes.style.backgroundColor = colorLeftTimesBackground;
                labelLeftTimes.style.color = colorLeftTimesNumber;
                labelLeftTimes.style.textShadow = "2px 2px 0px black";

                schedule.appendChild(labelLeftTimes);

                //draw line
                let labelLeftTimeLine = document.createElement('label');
                labelLeftTimeLine.style.position = 'absolute';
                labelLeftTimeLine.style.left = 0 + 'px';

                labelLeftTimeLine.style.top = (yPixelLocation + yTimePushLeftDown) + 'px';
                labelLeftTimeLine.style.width = fullWidth;
                labelLeftTimeLine.style.height = 5;
                labelLeftTimeLine.style.backgroundColor = colorLeftTimeLines;

                schedule.appendChild(labelLeftTimeLine);
                drawingTime = new Date(drawingTime.getTime() + milliSecondsInAnHour);
            }

        }

        function getYPixelLocation(earliestStart, time) {
            let hoursPast = (time.getTime() - earliestStart.getTime()) / milliSecondsInAnHour;
            let pixel = (yTimeHourHeight * hoursPast);
            return Number(pixel);
        }

        function drawEventsSchedule(events, earliestStart) {

            drawFaceupSchedule(events, earliestStart);
            drawHiddenOverlay(events, earliestStart);
        }

        function drawFaceupSchedule(events, earliestStart) {
            let schedule = document.getElementById("schedule");
            for (let i = 0; i < events.length; i++) {
                let event = events[i];

                let buttonViewable = document.createElement('button');
                buttonViewable.style.borderRadius = "12px";

                buttonViewable.style.position = 'absolute';
                buttonViewable.style.left = xTimeOnLeftWidth + 'px';
                let location = event.location;

                let startDate = new Date(getStartDateTime(event).getTime() + (1000 * 60 * getDelayMinutesForVenue(location)));
                let yPixelTop = getYPixelLocation(earliestStart, startDate);
                //TODO where is the 105 from?
                buttonViewable.style.top = (yPixelTop + 105) + 'px';
                buttonViewable.style.left = getXPixelForLocation(event);
                buttonViewable.style.width = xBlockWidth;
                let endDate = new Date(getEndDateTime(event).getTime() + (1000 * 60 * getDelayMinutesForVenue(location)));

                let height = getYPixelLocation(earliestStart, endDate) - yPixelTop;
                buttonViewable.style.height = height + 'px';
                buttonViewable.style.font = fontSchedule;
                
                buttonViewable.addEventListener("click", eventClick);
                buttonViewable.id = getScheduleViewableButtonId(event);
                buttonViewable.style.textAlign = "left";
                buttonViewable.style.paddingLeft = "15px";
                //third one to make grey
                buttonViewable.style.backgroundColor = "hsla(0, 0%, 20%, 1)";
                buttonViewable.style.color = "white";
                buttonViewable.style.textShadow = "2px 2px 0px black";
                buttonViewable.style.backgroundSize = 'cover';
                buttonViewable.style.backgroundPosition = 'center';
                buttonViewable.style.backgroundImage = "url(images/dog.png)";
                
                let bandInfo = bandToBandInfo.get(event.name);
                let genreText = "";
                if (bandInfo != null && bandInfo != "undefined")
                {
                    genreText = bandInfo.genre + "\n";
                }
                let goingInd = localStorage.getItem(common.getGoingKey(event));
                if (goingInd == null) {
                    goingInd = common.goingUndecided;
                }
                let text = event.name + "\n"  + genreText + getTimeString(startDate) + "-" + getTimeString(endDate);// + "\n" + goingInd;
                let buttonLabel = document.createElement("label");
                buttonLabel.innerText = text;
                //TODO wonder if making this id the same as the button is bad, but the click uses the id of the thing that was clicked to pick which overlay to show 
                buttonLabel.id = getScheduleViewableButtonId(event);
                buttonLabel.style.color = "white";
                buttonLabel.style.backgroundColor = "rgba(0, 0, 0, 1)"; // Set the background color of the text
                buttonViewable.appendChild(buttonLabel);
                //buttonViewable.innerText = text;

                let leftPortion = document.createElement("span");
                leftPortion.style.position = "absolute";
                leftPortion.style.top = "0";
                leftPortion.style.left = "0";
                leftPortion.style.width = "10px";
                leftPortion.style.height = "100%";
                leftPortion.style.backgroundSize = "10px 10px";

                if (goingInd == common.goingGoing)
                {
                    leftPortion.style.backgroundColor = "limegreen";
                    //buttonLabel.style.color = "limegreen";
                    buttonViewable.style.opacity = "1";
                }
                else if (goingInd == common.goingNotGoing)
                {
                    leftPortion.style.backgroundColor = "hsla(0, 100%, 25%, 1)";
                    buttonViewable.style.opacity = ".4";
                }
                else if (goingInd == common.goingMaybe)
                {
                    leftPortion.style.backgroundImage = "repeating-linear-gradient(-45deg, limegreen, limegreen 5px, black 5px, black 10px)"; // Striped pattern
                    buttonViewable.style.opacity = ".8";
                }
                else{
                    //TBD
                    leftPortion.style.backgroundColor = "hsla(240, 100%, 15%, 1)";
                    buttonViewable.style.opacity = ".7";
                }

                buttonViewable.appendChild(leftPortion);
                schedule.appendChild(buttonViewable);

            }
        }

        function getScheduleViewableButtonId(event) {
            return event.id + ",scheduleViewableButton";
        }

        function getTimeString(date) {
            let hour = date.getHours();
            if (hour > 12) {
                hour -= 12;
            }
            if (hour == 0)
            {
                hour = 12;
            }
            let minute = date.getMinutes();
            let minuteString = "";
            if (minute < 10) {
                minuteString += "0";
            }
            minuteString += minute;
            return hour + ":" + minuteString;
        }

        function drawHiddenOverlay(events, earliestStart) {
            let schedule = document.getElementById("schedule");
            for (let i = 0; i < events.length; i++) {
                let event = events[i];
                let location = event.location;
                let startDate = new Date(getStartDateTime(event).getTime() + (1000 * 60 * getDelayMinutesForVenue(location)));

                let yPixelTop = getYPixelLocation(earliestStart, startDate);
                
                let endDate = new Date(getStartDateTime(event).getTime() + (1000 * 60 * getDelayMinutesForVenue(location)));

                let height = getYPixelLocation(earliestStart, getEndDateTime(endDate)) - yPixelTop;

                let labelHidden = document.createElement('label');
                labelHidden.style.position = 'absolute';
                labelHidden.style.left = xTimeOnLeftWidth + 'px';

                labelHidden.style.top = (yPixelTop) + 'px';
                labelHidden.style.left = 0;
                labelHidden.style.width = "100%";
                labelHidden.style.height = yHiddenButtonHeight + 'px';
                labelHidden.style.font = "40px serif";
                labelHidden.style.backgroundColor = "hsla(0, 0%, 10%, .8)";
                labelHidden.style.color = "lightblue";
                labelHidden.style.visibility = 'hidden';
                labelHidden.id = getScheduleHiddenEventId(event);
                labelHidden.style.zIndex = 100000;

                let weirdButtonFix = document.createElement('button');
                weirdButtonFix.style.width = 0 + 'px';
                weirdButtonFix.style.height = 0 + 'px';
                weirdButtonFix.style.visibility = 'hidden';
                weirdButtonFix.style.bottom = "0";
                weirdButtonFix.style.position = "absolute";

                //TODO for some reason the label activates on the first button added
                labelHidden.appendChild(weirdButtonFix);

                schedule.appendChild(labelHidden);

                let labelBand = document.createElement('label');
                let conflicts = event.overlap.trim();
                if (conflicts == "")
                {
                    conflicts = "None.";
                }
                labelBand.innerText = event.name + "\n" + event.startTime + "-" + event.endTime + " " + event.endAMPM + "\n" + "Conflicts: " + conflicts;
                labelHidden.appendChild(labelBand);
                labelHidden.appendChild(document.createElement('div'));


                let buttonGoingUndecided = createButtonGoing(common.goingUndecided, schedule, event);
                let buttonGoingMaybe = createButtonGoing(common.goingMaybe, schedule, event);
                let buttonGoingGoing = createButtonGoing(common.goingGoing, schedule, event);
                let buttonGoingNotGoing = createButtonGoing(common.goingNotGoing, schedule, event);

                labelHidden.appendChild(buttonGoingGoing);
                labelHidden.appendChild(buttonGoingNotGoing);
                labelHidden.appendChild(buttonGoingMaybe);
                labelHidden.appendChild(buttonGoingUndecided);

                labelHidden.appendChild(document.createElement('div'));

                let buttonCloseOnLabel = document.createElement('button');
                buttonCloseOnLabel.style.borderRadius = "12px";
                buttonCloseOnLabel.style.width = "20%";
                buttonCloseOnLabel.style.height = 100 + 'px';
                buttonCloseOnLabel.innerText = closeButtonText;
                let closeId = getCloseButtonId(event);
                buttonCloseOnLabel.id = closeId;
                //buttonCloseOnLabel.style.bottom = "0";
                buttonCloseOnLabel.style.position = "absolute";
                buttonCloseOnLabel.style.font = fontCloseButton;
                buttonCloseOnLabel.style.top = 0;
                buttonCloseOnLabel.style.right = 0;
                buttonCloseOnLabel.style.opacity = ".7";
                buttonCloseOnLabel.style.backgroundColor = "hsla(0, 0%, 90%, 1)";

                buttonCloseOnLabel.addEventListener("click", closeHiddenLabel);
                labelHidden.appendChild(document.createElement('div'));

                labelHidden.appendChild(buttonCloseOnLabel);
                labelHidden.appendChild(document.createElement('div'));
                let alsoLabel = document.createElement('label');
                //TODO divs don't appear to do what I want
                alsoLabel.innerText = "\n\n\nAlso:";
                labelHidden.appendChild(alsoLabel);

                let eventsAll = eventNameToEvents.get(event.name);
                eventsAll.forEach(eventIter => {
                    if (eventIter.id == event.id) {
                        return;
                    }
                    labelHidden.appendChild(document.createElement('div'));

                    let labelBandAlso = document.createElement('label');

                    let conflicts = eventIter.overlap.trim();
                    if (conflicts == "")
                    {
                        conflicts = "None.";
                    }
                    labelBandAlso.innerText = "Day: " + eventIter.day + " " + " " + eventIter.startTime + "-" + eventIter.endTime + " " + eventIter.endAMPM + "\n" + "Conflicts: " + conflicts;
                    labelHidden.appendChild(labelBandAlso);
                    labelHidden.appendChild(document.createElement('div'));
                    let buttonGoingGoing = createButtonGoing(common.goingGoing, schedule, eventIter);
                    let buttonGoingUndecided = createButtonGoing(common.goingUndecided, schedule, eventIter);
                    let buttonGoingMaybe = createButtonGoing(common.goingMaybe, schedule, eventIter);
                    let buttonGoingNotGoing = createButtonGoing(common.goingNotGoing, schedule, eventIter);

                    labelHidden.appendChild(buttonGoingGoing);
                    labelHidden.appendChild(buttonGoingNotGoing);
                    labelHidden.appendChild(buttonGoingMaybe);
                    labelHidden.appendChild(buttonGoingUndecided);
                    
                    let buttonGoTo = createButtonGoTo(eventIter, schedule);
                    labelHidden.appendChild(buttonGoTo);

                });

                let note = document.createElement("textarea");
                note.style.width = "96%";
                note.style.marginLeft = "2%";
                note.style.height = 500;
                note.style.font = fontGoingButton;
                note.style.opacity = ".7";
                note.style.justifyContent = "center";
                note.id = event.name;

                let existingNote = localStorage.getItem(getNoteId(event.name));
                if (existingNote)
                {
                    note.value = decodeURI(existingNote);
                }
                else{
                    note.value = "Add band notes here";
                }
                note.addEventListener("input", function(textareaParam) {
                        console.log("Text in the textarea has changed:", note.value)
                    
                        console.log(textareaParam.target.id);
                        console.log(getNoteId(textareaParam.target.id));
                        localStorage.setItem(getNoteId(textareaParam.target.id), encodeURI(note.value));
                    }
                );

                labelHidden.appendChild(document.createElement('div'));
                labelHidden.appendChild(note);
                
            }
        }

        function getCloseButtonId(event) {
            return event.id + ",hiddenClose";
        }
        function getScheduleHiddenEventId(event) {
            return event.id + ",scheduleHidden";
        }

        function getNoteId(eventName)
        {
            return common.storedNoteKey + "," + eventName;
        }

        function createButtonGoTo(event, schedule) {
            let buttonGoTo = document.createElement('button');
            buttonGoTo.style.backgroundColor = colorGoToBackground;

            buttonGoTo.style.width = "20%";
            buttonGoTo.style.height = 100;
            buttonGoTo.innerText = goToButtonText;
            buttonGoTo.id = getGoToKey(event);
            buttonGoTo.style.font = fontGoingButton;

            buttonGoTo.addEventListener("click", goToClick);

            return buttonGoTo;
        }

        function getGoToKey(event) {
            return event.id + ",goto";
        }

        function goToClick(event) {
            let eventObject = common.getEventFromCommas(event.target.id);
            let day = eventObject.day;
            localStorage.setItem(common.storedDayKey, eventObject.day);

            let earliestStart = dayToData.get(Number(day)).earliestStart;
            let time = getStartDateTime(eventObject);

            let scrollToLocation = getYPixelLocation(earliestStart, time);
            localStorage.setItem(common.storedScrollToKey, scrollToLocation - 200);

            let parentLabel = event.target.parentElement;
            let label = common.getEventFromCommas(parentLabel.id);
            hideLabel(label);
            pauseRefreshing = false;
            redrawEverything();
        }

        function createButtonGoing(going, schedule, event) {

            let buttonGoingOnLabel = document.createElement('button');
            buttonGoingOnLabel.style.borderRadius = "12px";

            let goingInd = localStorage.getItem(common.getGoingKey(event));
            if (goingInd == null) {
                goingInd = common.goingUndecided;
                localStorage.setItem(common.getGoingKey(event), goingInd);
            }
            if (goingInd == going) {
                buttonGoingOnLabel.style.backgroundColor = colorGoingButtonActiveBackground;
            }
            else {
                buttonGoingOnLabel.style.backgroundColor = colorGoingButtonNonActiveBackground;
            }

            buttonGoingOnLabel.style.width = "20%";
            buttonGoingOnLabel.style.height = 100;
            buttonGoingOnLabel.innerText = going;
            buttonGoingOnLabel.id = common.getGoingKey(event);
            buttonGoingOnLabel.style.font = fontGoingButton;
            buttonGoingOnLabel.style.opacity = ".7";

            buttonGoingOnLabel.addEventListener("click", goingClick);

            return buttonGoingOnLabel;
        }

        function goingClick(theclick) {

            let schedule = document.getElementById("schedule");
            let parentLabel = theclick.target.parentElement;

            let id = theclick.target.id;
            let innerText = theclick.target.innerText;
            localStorage.setItem(id, innerText);

            const buttonsOnLabel = parentLabel.querySelectorAll("button");
            buttonsOnLabel.forEach(buttonGoingOnLabel => {
                let goingInd = localStorage.getItem(buttonGoingOnLabel.id);
                if (goingInd == null) {
                    if (buttonGoingOnLabel.innerText != closeButtonText && buttonGoingOnLabel.innerText != goToButtonText){
                        buttonGoingOnLabel.style.backgroundColor = colorGoingButtonNonActiveBackground;
                    }
                }
                else {
                    if (buttonGoingOnLabel.innerText == goingInd) {
                        //this is if the text of the button is the same as the stored going indication
                        buttonGoingOnLabel.style.backgroundColor = colorGoingButtonActiveBackground;
                    }
                    else{
                        buttonGoingOnLabel.style.backgroundColor = colorGoingButtonNonActiveBackground;
                    }
                }

            });

        }

        function hideLabel(event) {
            
            let labelHidden = document.getElementById(getScheduleHiddenEventId(event));
            labelHidden.style.visibility = 'hidden';
        }

        function closeHiddenLabel(event) {
            pauseRefreshing = false;
            let eventId = event.target.id;
            let theEvent = common.getEventFromCommas(event.target.id);
            hideLabel(theEvent);
            redrawEverything();

        }

        function eventClick(event) {
            let id = event.target.id;
            let eventWithValues = common.getEventFromCommas(id);
            let labelHidden = document.getElementById(getScheduleHiddenEventId(eventWithValues));
            labelHidden.style.visibility = 'visible';
            pauseRefreshing = true;
        }

        function getXPixelForLocation(event) {
            let locationIndex = getLocationIndex(event.location);

            let left = (locationIndex * xBlockWidth) + xTimeOnLeftWidth;
            return left;
        }

        function getLocationIndex(location) {
            for (let i = 0; i < common.locations.length; i++) {
                if (location === common.locations[i].abbrev) {
                    return i;
                }
            }
        }

        function handleDayButton(newDay) {
            if (newDay != day) {
                day = newDay;
                localStorage.setItem(common.storedDayKey, day);
                redrawEverything();
            }
        }

        function buttons() {
            
            resetButton("dayButton1", "29M");
            resetButton("dayButton2", "29T");
            resetButton("dayButton3", "30W");
            resetButton("dayButton4", "31R");

            document.getElementById("dayButton" + day).style.backgroundColor = colorDayBackgroundActive;
            document.getElementById("dayButton" + day).style.backgroundImage = "url(images/dude.png)";
            
            let buttonWidth = Math.floor(fullWidth / 7) + "px";
            document.getElementById("dayButton1").style.width = buttonWidth;
            document.getElementById("dayButton2").style.width = buttonWidth;
            document.getElementById("dayButton3").style.width = buttonWidth;
            document.getElementById("dayButton4").style.width = buttonWidth;
        }

        function resetButton(buttonName, buttonText)
        {
            let button = document.getElementById(buttonName);
            button.delete
            deleteAll(button, 'label');
            
            button.style.backgroundImage = "url(images/hands.png)";
            button.style.backgroundSize = 'cover';
            button.style.backgroundPosition = 'center';

            let buttonLabel = document.createElement("label");
            buttonLabel.innerText = buttonText;
            buttonLabel.style.color = "red";
            buttonLabel.style.backgroundColor = "rgba(0, 0, 0, 0.8)"; // Set the background color of the text
            button.appendChild(buttonLabel);
        }

        function goToNow() {
            for (var day = 1; day <= 4; day++) {
                let data = dayToData.get(day);
                if (data.earliestStart < common.storedTimeTEST && data.latestEnd > common.storedTimeTEST) {
                    localStorage.setItem(common.storedDayKey, day);

                    let scrollToLocation = getYPixelLocation(data.earliestStart, common.storedTimeTEST);
                    
                    localStorage.setItem(common.storedScrollToKey, scrollToLocation - 200);
                    redrawEverything();
                    return;
                }
            }
        }

        function alphaToggle() {
            window.location.assign("./alpha.html");
        }
        window.redrawEverything = redrawEverything;
        window.handleDayButton = handleDayButton;
        window.alphaToggle = alphaToggle;
        window.goToNow = goToNow;

    </script>

</head>

<body onload="redrawEverything(); setInterval('redrawEverything()', 60000);">
    <div class="top" id="top">
    </div>

    <div class="schedule" id="schedule"></div>
 
    <div class="bottom" id="bottom">
        <button type="button" onclick="handleDayButton(1)" id="dayButton1" class="button"></button>
        <button type="button" onclick="handleDayButton(2)" id="dayButton2" class="button"></button>
        <button type="button" onclick="handleDayButton(3)" id="dayButton3" class="button"></button>
        <button type="button" onclick="handleDayButton(4)" id="dayButton4" class="button"></button>
        <button type="button" onclick="goToNow()" id="goToNow" class="button"
            style="background-image: url(images/pinklady.png); background-size: cover; background-position: center; text-align: left">
            <label style="background-color:  rgba(0, 0, 0, 0.8); color: red">Now
            </label>
        </button>
        <button type="button" onclick="alphaToggle()" id="alphaToggle" class="button"
            style="background-image: url(images/pinklady.png); background-size: cover; background-position: center; text-align: left">
            <label style="background-color:  rgba(0, 0, 0, 0.8); color: red">List
            </label>
        </button>
    </div>

</body>

</html>
